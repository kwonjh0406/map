<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matzip Kakao Map Bridge</title>
    <style>
      html,
      body,
      #map {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        background: #fff;
      }
      #loading {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 2;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(29, 29, 29, 0.75);
        color: white;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="loading">Loading map...</div>
    <div id="map"></div>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const kakaoKey = params.get("kakaoKey") || "";
        const lat = Number(params.get("lat") || 36.5);
        const lng = Number(params.get("lng") || 127.8);

        const loading = document.getElementById("loading");

        function send(type, payload) {
          if (
            !window.ReactNativeWebView ||
            !window.ReactNativeWebView.postMessage
          )
            return;
          window.ReactNativeWebView.postMessage(
            JSON.stringify({ type, payload }),
          );
        }

        function hideLoading() {
          if (loading) loading.style.display = "none";
        }

        function initMap() {
          const container = document.getElementById("map");
          const map = new kakao.maps.Map(container, {
            center: new kakao.maps.LatLng(lat, lng),
            level: 4,
          });

          let activeMarkers = [];

          function clearMarkers() {
            activeMarkers.forEach((m) => m.setMap(null));
            activeMarkers = [];
          }

          window.renderFromApp = function renderFromApp(payload) {
            const centerData =
              payload && payload.center ? payload.center : { lat, lng };
            const markers = Array.isArray(payload && payload.markers)
              ? payload.markers
              : [];

            clearMarkers();
            map.setCenter(
              new kakao.maps.LatLng(centerData.lat, centerData.lng),
            );

            markers.forEach((p) => {
              const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(p.lat, p.lng),
              });

              const info = new kakao.maps.InfoWindow({
                content:
                  '<div style="padding:6px 8px;font-size:12px;">' +
                  p.name +
                  "</div>",
              });

              kakao.maps.event.addListener(marker, "click", function () {
                info.open(map, marker);
                send("marker_click", p);
              });

              activeMarkers.push(marker);
            });
          };

          hideLoading();
          send("map_ready", { ok: true });
        }

        if (!kakaoKey) {
          loading.textContent = "Missing kakaoKey query param";
          return;
        }

        const script = document.createElement("script");
        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${encodeURIComponent(kakaoKey)}`;
        script.onload = initMap;
        script.onerror = function () {
          loading.textContent = "Failed to load Kakao SDK";
        };
        document.head.appendChild(script);
      })();
    </script>
  </body>
</html>
