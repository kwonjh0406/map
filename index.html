<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matzip Kakao Map Bridge</title>
    <style>
      html,
      body,
      #map {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        background: #fff;
      }
      #loading {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 2;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(29, 29, 29, 0.75);
        color: white;
        font-size: 12px;
        max-width: 90vw;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div id="loading">Loading map...</div>
    <div id="map"></div>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const kakaoKey = params.get("kakaoKey") || "";
        const lat = Number(params.get("lat") || 36.5);
        const lng = Number(params.get("lng") || 127.8);

        const loading = document.getElementById("loading");

        function setLoading(msg) {
          if (loading) loading.textContent = msg;
        }

        function send(type, payload) {
          const data = { type, payload };
          if (
            window.ReactNativeWebView &&
            window.ReactNativeWebView.postMessage
          ) {
            window.ReactNativeWebView.postMessage(JSON.stringify(data));
          }
          if (window.parent && window.parent !== window) {
            window.parent.postMessage(data, "*");
          }
        }

        function fail(msg) {
          setLoading(msg);
          send("map_error", { message: msg });
        }

        function hideLoading() {
          if (loading) loading.style.display = "none";
        }

        window.addEventListener("error", function (e) {
          fail("Runtime error: " + (e.message || "unknown"));
        });

        function initMap() {
          try {
            if (!window.kakao || !window.kakao.maps) {
              fail("Kakao SDK loaded but kakao.maps is undefined");
              return;
            }

            const container = document.getElementById("map");
            const map = new kakao.maps.Map(container, {
              center: new kakao.maps.LatLng(lat, lng),
              level: 4,
            });
            const scheduleRelayout = function () {
              try {
                map.relayout();
              } catch (err) {
                // noop: relayout can fail briefly while webview/iframe is stabilizing.
              }
            };
            requestAnimationFrame(scheduleRelayout);
            setTimeout(scheduleRelayout, 150);
            setTimeout(scheduleRelayout, 500);
            window.addEventListener("resize", scheduleRelayout);

            let activeMarkers = [];
            let myLocationMarker = null;
            let myLocationCircle = null;
            let viewportTick = null;

            function emitViewportChanged() {
              try {
                const mapCenter = map.getCenter();
                const bounds = map.getBounds();
                const sw = bounds.getSouthWest();
                const ne = bounds.getNorthEast();
                send("map_viewport_changed", {
                  center: { lat: mapCenter.getLat(), lng: mapCenter.getLng() },
                  bounds: {
                    sw: { lat: sw.getLat(), lng: sw.getLng() },
                    ne: { lat: ne.getLat(), lng: ne.getLng() },
                  },
                  level: map.getLevel(),
                });
              } catch (err) {
                // noop
              }
            }

            function clearMarkers() {
              activeMarkers.forEach((m) => m.setMap(null));
              activeMarkers = [];
            }

            function clearMyLocation() {
              if (myLocationMarker) myLocationMarker.setMap(null);
              if (myLocationCircle) myLocationCircle.setMap(null);
              myLocationMarker = null;
              myLocationCircle = null;
            }

            function renderMyLocation(pos) {
              clearMyLocation();
              if (
                !pos ||
                typeof pos.lat !== "number" ||
                typeof pos.lng !== "number"
              )
                return;

              const center = new kakao.maps.LatLng(pos.lat, pos.lng);
              myLocationCircle = new kakao.maps.Circle({
                center,
                radius: 40,
                strokeWeight: 1,
                strokeColor: "#1f7aff",
                strokeOpacity: 0.7,
                strokeStyle: "solid",
                fillColor: "#1f7aff",
                fillOpacity: 0.15,
              });
              myLocationCircle.setMap(map);

              myLocationMarker = new kakao.maps.Marker({
                map,
                position: center,
              });
            }

            window.renderFromApp = function renderFromApp(payload) {
              const centerData = payload && payload.center ? payload.center : null;
              const moveCenter = !!(payload && payload.moveCenter);
              const markers = Array.isArray(payload && payload.markers)
                ? payload.markers
                : [];
              const myLocation =
                payload && payload.myLocation ? payload.myLocation : null;

              clearMarkers();
              if (
                moveCenter &&
                centerData &&
                typeof centerData.lat === "number" &&
                typeof centerData.lng === "number"
              ) {
                map.setCenter(new kakao.maps.LatLng(centerData.lat, centerData.lng));
              }
              renderMyLocation(myLocation);

              markers.forEach((p) => {
                const marker = new kakao.maps.Marker({
                  map,
                  position: new kakao.maps.LatLng(p.lat, p.lng),
                });

                const info = new kakao.maps.InfoWindow({
                  content:
                    '<div style="padding:6px 8px;font-size:12px;">' +
                    p.name +
                    "</div>",
                });

                kakao.maps.event.addListener(marker, "click", function () {
                  info.open(map, marker);
                  send("marker_click", p);
                });

                activeMarkers.push(marker);
              });

              if (viewportTick) clearTimeout(viewportTick);
              viewportTick = setTimeout(emitViewportChanged, 0);
            };

            function handleBridgeMessage(event) {
              try {
                const message =
                  typeof event.data === "string"
                    ? JSON.parse(event.data)
                    : event.data;
                if (!message || message.type !== "render_from_app") return;
                window.renderFromApp(message.payload || {});
              } catch (err) {
                fail(
                  "Invalid bridge message: " +
                    (err && err.message ? err.message : String(err)),
                );
              }
            }

            // RN WebView bridge differs by platform: iOS uses window, Android can use document.
            window.addEventListener("message", handleBridgeMessage);
            document.addEventListener("message", handleBridgeMessage);
            kakao.maps.event.addListener(map, "idle", function () {
              emitViewportChanged();
            });

            hideLoading();
            send("map_ready", { ok: true });
            setTimeout(function () {
              send("map_ready", { ok: true, retry: 1 });
            }, 250);
          } catch (err) {
            fail(
              "initMap failed: " +
                (err && err.message ? err.message : String(err)),
            );
          }
        }

        if (!kakaoKey) {
          fail("Missing kakaoKey query param");
          return;
        }

        setTimeout(function () {
          if (loading && loading.style.display !== "none") {
            fail("Timeout loading Kakao SDK (check CSP/domain/key)");
          }
        }, 10000);

        const script = document.createElement("script");
        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?autoload=false&appkey=${encodeURIComponent(
          kakaoKey,
        )}`;
        script.async = false;
        script.onload = function () {
          if (!window.kakao || !window.kakao.maps || !window.kakao.maps.load) {
            fail("Kakao SDK loaded but kakao.maps.load is unavailable");
            return;
          }
          window.kakao.maps.load(initMap);
        };
        script.onerror = function () {
          fail("Failed to load Kakao SDK (network/CSP/domain)");
        };
        document.head.appendChild(script);
      })();
    </script>
  </body>
</html>
